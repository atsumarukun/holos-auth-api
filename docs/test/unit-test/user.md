# User ユニットテスト

## エンティティ

### NewUser
| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| IDに値があるか | 正常系 | エラーが発生しない | IDがuuid.Nilでない |
| 名前が入力値と等しいか | 正常系 | 名前の入力値が"name" | Nameの値が"name" |
| パスワードに値があるか | 正常系 | パスワードの入力値が"password" <br />確認用パスワードの入力値が"password" | Passwordが空文字列でない |
| パスワードが入力値と等しくないか | 正常系 | パスワードの入力値が"password" <br />確認用パスワードの入力値が"password" | Passwordの値が"password"でない |
| 作成日に値があるか | 正常系 | エラーが発生しない | CreatedAtがtime.IsZero()がfalse |
| 更新日に値があるか | 正常系 | エラーが発生しない | UpdatedAtがtime.IsZero()がfalse |
| 作成日と更新日が等しいか | 正常系 | エラーが発生しない | CreatedAtとUpdatedAtが等しい |
| 不正な名前を受け付けないか | 異常系 | 名前の入力値が"なまえ" | ErrInvalidUserNameが出力される |
| 不正なパスワードを受け付けないか | 異常系 | パスワードの入力値が"ぱすわーど" | ErrInvalidUserPasswordが出力される |

### SetName

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 小文字を受け付けるか | 正常系 | 入力値が"name" | Nameの値が"name"<br />エラーが出力されない |
| 大文字を受け付けるか | 正常系 | 入力値が"NAME" | Nameの値が"NAME"<br />エラーが出力されない |
| 数字を受け付けるか | 正常系 | 入力値が"name01" | Nameの値が"name01"<br />エラーが出力されない |
| アンダースコアを受け付けるか | 正常系 | 入力値が"sample_name" | Nameの値が"sample_name"<br />エラーが出力されない |
| ひらがなを受け付けないか | 異常系 | 入力値が"なまえ" | ErrInvalidUserNameが出力される |
| ハイフンを受け付けないか | 異常系 | 入力値が"sample-name" | ErrInvalidUserNameが出力される |
| スラッシュを受け付けないか | 異常系 | 入力値が"sample/name" | ErrInvalidUserNameが出力される |
| 2文字を受け付けないか | 異常系 | 入力値がstrings.Repeat("a", 2) | ErrUserNameTooShortが出力される |
| 3文字を受け付けるか | 正常系 | 入力値がstrings.Repeat("a", 3) | Nameの値がstrings.Repeat("a", 3)<br />エラーが出力されない |
| 24文字を受け付けるか | 正常系 | 入力値がstrings.Repeat("a", 24) | Nameの値がstrings.Repeat("a", 24)<br />エラーが出力されない |
| 25文字を受け付けないか | 異常系 | 入力値がstrings.Repeat("a", 25) | ErrUserNameTooLongが出力される |
| 更新日時が更新されるか | 正常系 | エラーが発生しない | UpdatedAtの値が関数実行時の値より大きい |

### SetPassword

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 小文字を受け付けるか | 正常系 | パスワードの入力値が"password"<br />確認用パスワードの入力値が"password" | Passwordの値が更新される<br />エラーが出力されない |
| 大文字を受け付けるか | 正常系 | パスワードの入力値が"PASSWORD"<br />確認用パスワードの入力値が"PASSWORD" | Passwordの値が更新される<br />エラーが出力されない |
| 数字を受け付けるか | 正常系 | パスワードの入力値が"password01"<br />確認用パスワードの入力値が"password01" | Passwordの値が更新される<br />エラーが出力されない |
| 記号を受け付けるか | 正常系 | パスワードの入力値が"!@#\$%^&\*()\_\-+=\[\]{};:'\",.<>?/\\|~"<br />確認用パスワードの入力値が"!@#\$%^&\*()\_\-+=\[\]{};:'\",.<>?/\\|~" | Passwordの値が更新される<br />エラーが出力されない |
| ひらがなを受け付けないか | 異常系 | パスワードの入力値が"ぱすわーど"<br />確認用パスワードの入力値が"ぱすわーど" | ErrInvalidUserPasswordが出力される |
| 7文字を受け付けないか | 異常系 | パスワードの入力値がstrings.Repeat("a", 7)<br />確認用パスワードの入力値がstrings.Repeat("a", 7) | ErrUserPasswordTooShortが出力される |
| 7文字を受け付けるか | 正常系 | パスワードの入力値がstrings.Repeat("a", 8)<br />確認用パスワードの入力値がstrings.Repeat("a", 8) | Passwordの値が更新される<br />エラーが出力されない |
| 72文字を受け付けるか | 正常系 | パスワードの入力値がstrings.Repeat("a", 72)<br />確認用パスワードの入力値がstrings.Repeat("a", 72) | Passwordの値が更新される<br />エラーが出力されない |
| 73文字を受け付けないか | 異常系 | パスワードの入力値がstrings.Repeat("a", 73)<br />確認用パスワードの入力値がstrings.Repeat("a", 73) | ErrUserPasswordTooLongが出力される |
| パスワードと確認用パスワードが一致しない | 異常系 | パスワードの入力値が"password"<br />確認用パスワードの入力値が"confirm_password" | ErrUserPasswordDoesNotMatchが出力される |
| 更新日時が更新されるか | 正常系 | エラーが発生しない | UpdatedAtの値が関数実行時の値より大きい |

### ComparePassword

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| パスワードが一致 | 正常系 | エンティティのパスワードが"password"<br />入力値が"password" | エラーが出力されない |
| パスワードが不一致 | 異常系 | エンティティのパスワードが"password"<br />入力値が"PASSWORD" | ErrAuthenticationFailedが出力される |

## ドメインサービス

### Exists

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザーが見つかる | 正常系 | モックリポジトリからのUser戻り値がNilでない | trueが返却される |
| ユーザーが見つからない | 正常系 | モックリポジトリからのUser戻り値がNil | falseが返却される |
| リポジトリでエラーが発生する | 異常系 | モックリポジトリからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

## リポジトリ

### Create

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 実行されるSQLが一致する | 正常系 | エラーが発生しない | SQLが"INSERT INTO users (id, name, password, created_at, updated_at) VALUES (?, ?, ?, ?, ?);" |
| ORMでエラーが発生する | 異常系 | モックDBからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| Nilが入力される | 異常系 | 入力値がNil | ErrRequiredUserが発生する |

### Update

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 実行されるSQLが一致する | 正常系 | エラーが発生しない | SQLが"UPDATE users SET name = ?, password = ?, updated_at = ? WHERE id = ? AND deleted_at IS NULL LIMIT 1;" |
| ORMでエラーが発生する | 異常系 | モックDBからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| Nilが入力される | 異常系 | 入力値がNil | ErrRequiredUserが発生する |

### Delete

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 実行されるSQLが一致する | 正常系 | エラーが発生しない | SQLが"UPDATE users SET updated_at = updated_at, deleted_at = NOW(6) WHERE id = ? AND deleted_at IS NULL LIMIT 1;" |
| ORMでエラーが発生する | 異常系 | モックDBからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| Nilが入力される | 異常系 | 入力値がNil | ErrRequiredUserが発生する |

### FindOneByIDAndNotDeleted

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 実行されるSQLが一致する | 正常系 | エラーが発生しない | SQLが"SELECT id, name, password, created_at, updated_at FROM users WHERE id = ? AND deleted_at IS NULL LIMIT 1;" |
| ユーザーが見つからない | 正常系 | モックDB空のエラー戻り値がsql.ErrNoRows | ユーザーの戻り値がNil<br />エラーが出力されない |
| ORMでエラーが発生する | 異常系 | モックDBからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

### FindOneByName

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| 実行されるSQLが一致する | 正常系 | エラーが発生しない | SQLが"SELECT id, name, password, created_at, updated_at FROM users WHERE name = ? LIMIT 1;" |
| ユーザーが見つからない | 正常系 | モックDB空のエラー戻り値がsql.ErrNoRows | ユーザーの戻り値がNil<br />エラーが出力されない |
| ORMでエラーが発生する | 異常系 | モックDBからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

## ユースケース

### Create

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザーが作成される | 正常系 | 名前の入力値が"name"<br />パスワードの入力値が"password"<br />確認用パスワードの入力値が"password"<br />モックリポジトリからのUser戻り値がNilでない | エラーが出力されない |
| 不正な値が入力される | 異常系 | 名前の入力値が"なまえ" | ErrInvalidUserNameが出力される |
| ユーザー名が利用されている | 異常系 | モックサービスからの戻り値がtrue | ErrUserAlreadyExistsが出力される |
| サービスでエラーが発生する | 異常系 | モックサービスからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| リポジトリでエラーが発生する | 異常系 | モックリポジトリからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |


### UpdateName

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザー名が更新される | 正常系 | 名前の入力値が"name"<br />モックリポジトリからのUser戻り値がNilでない | エラーが出力されない |
| 不正な値が入力される | 異常系 | 名前の入力値が"なまえ" | ErrInvalidUserNameが出力される |
| ユーザーが見つからない | 異常系 | モックリポジトリからのUser戻り値がNil | ErrUserNotFoundが出力される |
| ユーザー名が利用されている | 異常系 | モックサービスからの戻り値がtrue | ErrUserAlreadyExistsが出力される |
| サービスでエラーが発生する | 異常系 | モックサービスからのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| リポジトリからの取得でエラーが発生する | 異常系 | モックリポジトリの取得関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| リポジトリでの更新でエラーが発生する | 異常系 | モックリポジトリの更新関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

### UpdatePassword

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| パスワードが更新される | 正常系 | ユーザーのパスワードが"password"<br />新規パスワードの入力値が"update"<br />確認用パスワードの入力値が"update"<br />モックリポジトリからのUser戻り値がNilでない | エラーが出力されない |
| 不正な値が入力される | 異常系 | 新規パスワードの入力値が"ぱすわーど"<br />確認用パスワードの入力値が"ぱすわーど" | ErrInvalidUserPasswordが出力される |
| パスワード検証に失敗 | 異常系 | ユーザーのパスワードが"password"<br />ログイン用パスワードの入力値が"invalid" | ErrAuthenticationFailedが出力される |
| パスワードが不一致 | 異常系 | パスワードの入力値が"password"<br />確認用パスワードの入力値が"confirm_password" | ErrAuthenticationFailedが出力される |
| ユーザーが見つからない | 異常系 | モックリポジトリからのUser戻り値がNil | ErrUserNotFoundが出力される |
| リポジトリからの取得でエラーが発生する | 異常系 | モックリポジトリの取得関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| リポジトリでの更新でエラーが発生する | 異常系 | モックリポジトリの更新関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

### Delete

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザーが削除される | 正常系 | エラーが発生しない | エラーが出力されない |
| ユーザーが見つからない | 異常系 | モックリポジトリからのUser戻り値がNil | ErrUserNotFoundが出力される |
| パスワード検証に失敗 | 異常系 | ユーザーのパスワードが"password"<br />ログイン用パスワードの入力値が"invalid" | ErrAuthenticationFailedが出力される |
| リポジトリからの取得でエラーが発生する | 異常系 | モックリポジトリの取得関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |
| リポジトリでの削除でエラーが発生する | 異常系 | モックリポジトリの削除関数からのエラー戻り値がNilでない | エラーがモックの返却値と一致する |

## ハンドラ

### Create

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザーが作成される | 正常系 | リクエストJSONが"{'name': 'name', 'password': 'password', 'confirm_password': 'password'}"<br />モックユースケースのエラー戻り値がNIL | ステータスコードが201 |
| 不正なリクエスト | 異常系 | リクエストJSONが空文字列 | ステータスコードが400 |
| ユースケースでエラーが発生する | 異常系 | モックユースケースのエラー戻り値がNilでない | ステータスコードが500 <br />エラーメッセージが"internal server error"|

### UpdateName

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザー名が更新される | 正常系 | リクエストJSONが"{'name': 'name'}"<br />コンテキストにユーザーIDが含まれる<br />モックユースケースのエラー戻り値がNIL | ステータスコードが200 |
| コンテキストにユーザーIDが含まれない | 異常系 | コンテキストにユーザーIDが含まれない | ステータスコードが500<br />エラーメッセージが"internal server error" |
| 不正なリクエスト | 異常系 | リクエストJSONが空文字列 | ステータスコードが400 |
| ユースケースでエラーが発生する | 異常系 | モックユースケースのエラー戻り値がNilでない | ステータスコードが500 <br />エラーメッセージが"internal server error"|

### UpdatePassword

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| パスワードが更新される | 正常系 | リクエストJSONが"{’current_password’: ’password’, ’new_password’: ’new_password’, ’confirm_new_password’: ’new_password’}"<br />コンテキストにユーザーIDが含まれる<br />モックユースケースのエラー戻り値がNIL | ステータスコードが200 |
| コンテキストにユーザーIDが含まれない | 異常系 | コンテキストにユーザーIDが含まれない | ステータスコードが500<br />エラーメッセージが"internal server error" |
| 不正なリクエスト | 異常系 | リクエストJSONが空文字列 | ステータスコードが400 |
| ユースケースでエラーが発生する | 異常系 | モックユースケースのエラー戻り値がNilでない | ステータスコードが500 <br />エラーメッセージが"internal server error"|

### Delete

| テストケース | タイプ | 条件 | 期待値 |
| --- | --- | --- | --- |
| ユーザーが削除される | 正常系 | リクエストJSONが"{'password': 'password'}"<br />コンテキストにユーザーIDが含まれる<br />モックユースケースのエラー戻り値がNIL | ステータスコードが200 |
| コンテキストにユーザーIDが含まれない | 異常系 | コンテキストにユーザーIDが含まれない | ステータスコードが500<br />エラーメッセージが"internal server error" |
| 不正なリクエスト | 異常系 | リクエストJSONが空文字列 | ステータスコードが400 |
| ユースケースでエラーが発生する | 異常系 | モックユースケースのエラー戻り値がNilでない | ステータスコードが500 <br />エラーメッセージが"internal server error"|
